
---

#apiVersion: v1
#kind: PersistentVolumeClaim
#metadata:
#  name: efs-oam-prod
#spec:
#  accessModes:
#    - ReadWriteMany
#  storageClassName: efs-sc
#  resources:
#    requests:
#      storage: 1Mi

---

# Zoo Keeper
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: isa-zk
spec:
  serviceName: zk-service
  replicas: 1
  selector:
    matchLabels:
      app: isa-zk
  template:
    metadata:
      labels:
        app: isa-zk
    spec:
      containers:
      - name: isa-zk
        imagePullPolicy: Always
        image: bitnami/zookeeper:3.8.0      #agirish/zookeeper:3.6.0
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
               
        ports:
        - containerPort: 2181
          name: client
        - containerPort: 2888
          name: server
        - containerPort: 3888
          name: leader-election          
        env:
          - name: ALLOW_ANONYMOUS_LOGIN
            value: "yes"        
          - name: ZOO_TICK_TIME
            value: "4000"
          - name: ZOO_INIT_LIMIT
            value: "100"
          - name: ZOO_SYNC_LIMIT
            value: "10"
          - name: ZOO_MAX_CNXNS
            value: "0"
          - name: ZOO_MAX_CLIENT_CNXNS
            value: "600"
          - name: ZOO_AUTOPURGE_INTERVAL
            value: "0"
          - name: ZOO_HEAP_SIZE
            value: "1536"
          - name: ZOO_MAX_SESSION_TIMEOUT
            value: "100000"
        resources: 
           limits:
              cpu: 700m
              memory: 2500Mi
           requests:
              cpu: 700m
              memory: 2500Mi

---

# Drill 
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: isa-drill
spec:
  serviceName: isa-drill-service
  replicas: 1
  selector:
    matchLabels:
      app: isa-drill
  template:
    metadata:
      labels:
        app: isa-drill
    spec:
      containers:
      - name: isa-drill
        imagePullPolicy: Always
        image: infobeltinc/apache-drill:1.19.0  #agirish/drill:1.17.0 # smizy/apache-drill:1.16.0-alpine
        env:
          - name: CLUSTER_ID
            value: drillcluster
          - name: ZK_SERVERS
            value: "zk-service:2181"        
          - name: DRILL_CLUSTER_ID
            value: drillcluster # {{ .Values.service.drillClusterID }}
          - name: DRILL_HEAP
            value: "2G" # {{ .Values.service.drillHeap }}
          - name: DRILL_MAX_DIRECT_MEMORY
            value: "6G" # {{ .Values.service.maxDirectMemory }}
          - name: DRILL_ZOOKEEPER_QUORUM
            value: "zk-service:2181" # {{ .Values.service.drillZkHosts }}
          - name: DRILL_ZK_ROOT
            value: drillcluster # {{ .Values.service.drillClusterID }}
          - name: DRILL_HTTP_PORT
            value: "8047"
          - name: DRILL_USER_SERVER_PORT
            value: "31010"
        ports:
        - containerPort: 8047 # {{ .Values.service.drillHttpPort }}
          name: http
        - containerPort: 31010 # {{ .Values.service.drillUserPort }}
          name: userport
        - containerPort: 31011 # {{ .Values.service.drillControlPort }}
          name: controlport
        - containerPort: 31012 # {{ .Values.service.drillDataPort }}
          name: dataport
        tty: true  
        volumeMounts:
        - mountPath: /var/lib/isa
          name: efs-oam-prod
        - mountPath: /opt/drill/conf/drill-override.conf
          name: drill-config-cm
          subPath: drill-override.conf
        - mountPath: /opt/drill/conf/drill-env.sh
          name: drill-config-cm
          subPath: drill-env.sh
        resources: 
            limits:
               cpu: 700m
               memory: 5500Mi
            requests:
               cpu: 700m
               memory: 4500Mi
      volumes:
        - name: efs-oam-prod
          persistentVolumeClaim:
            claimName: efs-oam-prod
        - name: drill-config-cm
          configMap:
            name: drill-config-cm            
      initContainers:
        - name: zk-available
          image: busybox
          command: ['sh', '-c', 'until nc -z zk-service 2181; do echo Waiting for ZK to come up; sleep 5; done; ']

---

# OAM ONBOARDING UI

apiVersion: apps/v1
kind: Deployment
metadata:
  name: isa-onboarding
spec:
  replicas: 1
  selector:
    matchLabels:
      app: isa-onboarding
  template:
    metadata:
      labels:
        app: isa-onboarding
    spec:
      containers:      
      - name: isa-onboarding
        image: "997742452154.dkr.ecr.us-west-2.amazonaws.com/infobelt/oam-onboarding:0.0.1-SNAPSHO2"
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 9090
        env:
          - name: ORION_SERVER
            value: "onboarding"
          - name: SPRING_DATASOURCE_DRIVERCLASSNAME
            value: oracle.jdbc.driver.OracleDriver
          - name: SPRING_DATASOURCE_URL
            value: jdbc:oracle:thin:@oam-ui.c6njtcwgnr85.us-west-2.rds.amazonaws.com:1521:OPENSKYE
          - name: SPRING_DATASOURCE_USERNAME
            value: oam
          - name: SPRING_DATASOURCE_PASSWORD
            value: changeme     
          - name: SERVER_PORT
            value: "9090"
          - name: SERVER_SERVLET_CONTEXT_PATH
            value: "/webapp"
#          - name: SERVER_SSL_ENABLED
#            value: "false"
        volumeMounts:
          - name: efs-oam-prod
            mountPath: /var/lib/isa
        resources:
             limits:
                 cpu: 400m
                 memory: 2000Mi
             requests:
                 cpu: 300m
                 memory: 2000Mi
      terminationGracePeriodSeconds: 10
      volumes:
        - name: efs-oam-prod
          persistentVolumeClaim:
            claimName: efs-oam-prod           


---

# OAM UI

apiVersion: apps/v1
kind: Deployment
metadata:
  name: isa-ui
spec:
  replicas: 1
  selector:
    matchLabels:
      app: isa-ui
  template:
    metadata:
      labels:
        app: isa-ui
    spec:
      containers:      
      - name: isa-ui
        image: "997742452154.dkr.ecr.us-west-2.amazonaws.com/infobelt/oam-saas:4.52.22"
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 8090
        env:
          - name: ORION_SERVER
            value: "ui"
          - name: SERVER_PORT
            value: "8090"
          - name: SERVER_SERVLET_CONTEXT_PATH
            value: "/webapp"
          - name: SERVER_SSL_ENABLED
            value: "false"
          - name: SKYE_HOSTNAME
            value: "isa-server"
        resources:
             limits:
                 cpu: 400m
                 memory: 2000Mi
             requests:
                 cpu: 400m
                 memory: 2000Mi               
        volumeMounts:
          - name: efs-oam-prod
            mountPath: /var/lib/isa      
      terminationGracePeriodSeconds: 10
      volumes:
        - name: efs-oam-prod
          persistentVolumeClaim:
            claimName: efs-oam-prod         

---
            
apiVersion: apps/v1
kind: Deployment
metadata:
  name: isa-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: isa-server    
  template:
    metadata:
      labels:
        app: isa-server  
    spec:
      containers:        
      - name: isa-server
        image: "997742452154.dkr.ecr.us-west-2.amazonaws.com/infobelt/oam-saas:4.52.22"
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 8080
        env:
          - name: ORION_SERVER
            value: "server"
          - name: SPRING_DATASOURCE_DRIVERCLASSNAME
            value: oracle.jdbc.driver.OracleDriver
          - name: SPRING_DATASOURCE_URL
            value: jdbc:oracle:thin:@oam-poc.c6njtcwgnr85.us-west-2.rds.amazonaws.com:1521:OPENSKYE
          - name: SPRING_DATASOURCE_USERNAME
            value: openskye
          - name: SPRING_DATASOURCE_PASSWORD
            value: changeme
          - name: SPRING_DATA_JE